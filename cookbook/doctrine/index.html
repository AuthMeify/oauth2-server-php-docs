<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta http-equiv="Content-Language" content="en-us" />
  <meta http-equiv="imagetoolbar" content="false" />
  <meta name="MSSmartTagsPreventParsing" content="true" />
  <title>Doctrine</title>
  <link rel="alternate" type="application/atom+xml" title="API Changes" href="changes.atom" />
  <link href="/oauth2-server-php-docs/css/reset.css" rel="stylesheet" type="text/css" />
  <link href="/oauth2-server-php-docs/css/960.css" rel="stylesheet" type="text/css" />
  <link href="/oauth2-server-php-docs/css/uv_active4d.css" rel="stylesheet" type="text/css" />
  <link href="/oauth2-server-php-docs/shared/css/documentation.css" media="screen" rel="stylesheet" type="text/css">
  <link href="/oauth2-server-php-docs/shared/css/pygments.css" media="screen" rel="stylesheet" type="text/css">
  <script src="/oauth2-server-php-docs/shared/js/jquery.js" type="text/javascript"></script>
  <script src="/oauth2-server-php-docs/shared/js/documentation.js" type="text/javascript"></script>
</head>
<body class="api">
    <div id="header-wrapper">
      <div id="header">
        <div>
          <a class="logo" href="/oauth2-server-php-docs/">
            <img src="/oauth2-server-php-docs/images/OAuth2.png" style="height:107px;float:left"/>
            <strong>OAuth2 Server PHP</strong>
          </a>
          <ul class="nav">
            <li><a href="/oauth2-server-php-docs/changes/">Changes</a></li>
            <li><a href="/oauth2-server-php-docs/changes.atom">
              <img src="/oauth2-server-php-docs/images/feed-icon-28x28.png" width="16" height="16" alt="GitHub API Changes Feed" />
            </a></li>
          </ul>
        </div>
      </div><!-- #header -->
    </div><!-- #header-wrapper -->

    <div id="wrapper">
      <div class="content">
    <h2 id="create-client-and-access-token-storage">Create Client and Access Token Storage</h2>

<p>To integrate doctrine into your project, first set up your models.  Let’s start with just the Client and Access Token models:</p>

<p>```yaml
OAuthClient:
  tableName:      oauth_client
  columns:
    client_identifier:
      type:       string(50)
      notnull:    true
    client_secret:
      type:       char(20)
      notnull:    true
    redirect_uri:
      type:       string(255)
      notnull:    true
      default:    “”</p>

<p>OAuthAccessToken:
  tableName:      oauth_access_token
  columns:
    token:
      type:       char(40)
      notnull:    true
      unique:     true
    client_identifier:
      type:       string(50)
      notnull:    true
    user_identifier:
      type:       string(100)
      notnull:    true
    expires:
      type:       timestamp
      notnull:    true
    scope:
      type:       string(50)
      notnull:    false
  relations:
    Client:
      local:        client_identifier
      foreign:      client_identifier
      class:        OAuthClient
      foreignAlias: AccessTokens
      onDelete:     CASCADE
      onUpdate:     CASCADE
```</p>

<p>Once you’ve generated the models off this schema, you will have an <code>OAuthClient</code> and <code>OAuthCleintTable</code> class
file, as well as an <code>OAuthAccessToken</code> and <code>OAuthAccessTokenTable</code> object.</p>

<p>Implement <code>OAuth2\Storage\ClientCredentialsInterface</code> on the <code>OAuthClientTable</code> class:</p>

<p>```php
class OAuthClientTable extends PluginOAuthClientTable implements OAuth2\Storage\ClientCredentialsInterface
{
    public function getClientDetails($client_id)
    {
        $client = $this-&gt;createQuery()
            -&gt;where(‘client_identifier = ?’, $client_id)
            -&gt;fetchOne(array(), Doctrine::HYDRATE_ARRAY);</p>

<pre><code>    return $client;
}

public function checkClientCredentials($client_id, $client_secret = NULL)
{
    $client = $this-&gt;getClientDetails($client_id);

    if ($client) {
        return $client['client_secret'] === sha1($client_secret);
    }
    return false;
}

public function checkRestrictedGrantType($client_id, $grant_type)
{
    // we do not support different grant types per client in this example
    return true;
} } ```
</code></pre>

<p>Now implement <code>OAuth2\Storage\AccessTokenInterface</code> on the <code>OAuthAccessTokenTable</code> class:</p>

<p>```php
class OAuthAccessTokenTable extends PluginOAuthAccessTokenTable implements OAuth2\Storage\AccessTokenInterface
{
    public function getAccessToken($oauth_token)
    {
        $token = $this-&gt;createQuery()
            -&gt;where(‘token = ?’, $oauth_token)
            -&gt;fetchOne(array(), Doctrine_Core::HYDRATE_ARRAY);</p>

<pre><code>    if ($token) {
        return array(
           'token'     =&gt; $token['token'],
           'client_id' =&gt; $token['client_identifier'],
           'expires'   =&gt; strtotime($token['expires']),
           'scope'     =&gt; $token['scope'],
           'user_id'   =&gt; $token['user_identifier'],
        );
    }
}

public function setAccessToken($oauth_token, $client_id, $user_id, $expires, $scope = null)
{
    $token = new OAuthAccessToken();
    $token-&gt;fromArray(array(
       'token'              =&gt; $oauth_token,
       'client_identifier'  =&gt; $client_id,
       'user_identifier'    =&gt; $user_id,
       'expires'            =&gt; date('Y-m-d H:i:s', $expires),
       'scope'              =&gt; $scope,
    ));

    $token-&gt;save();
} } ```
</code></pre>

<p>Good job!  Now, when you create your <code>OAuth\Server</code> object, pass these tables in:</p>

<p>```php
$clientStore = Doctrine::getTable(‘OAuthClient’);
$tokenStore  = Doctrine::getTable(‘OAuthAccessToken’);</p>

<p>// Pass the doctrine storage objects to the OAuth2 server class
$server = new OAuth2\Server(array(‘client_credentials’ =&gt; $clientStore, ‘access_token’ =&gt; $tokenStore));
```</p>

<p>You’ve done it!  You’ve integrated your server with Doctrine!  You can go to town using it, but
since you’ve only passed it a <code>client_credentials</code> and <code>access_token</code> storage object, you can only
use the <code>client_credentials</code> grant type:</p>

<p>```php
// will only be able to handle token requests when “grant_type=client_credentials”.
$server-&gt;addGrantType(new OAuth2\GrantType\ClientCredentials($clientStorage));</p>

<p>// handle the request
$server-&gt;handleTokenRequest(OAuth2\Request::createFromGlobals())-&gt;send();
```</p>

<h2 id="add-authorization-code-and-refresh-token-storage">Add Authorization Code and Refresh Token Storage</h2>

<p>So lets make our application a little more exciting.  Add the following to your schema and
generate the class files:</p>

<p>```yaml
OAuthAuthorizationCode:
  tableName:      oauth_authorization_code
  columns:
    code:
      type:       char(40)
      notnull:    true
      unique:     true
    client_identifier:
      type:       string(50)
      notnull:    true
    expires:
      type:       timestamp
      notnull:    true
    user_identifier:
      type:       string(100)
      notnull:    true
    redirect_uri:
      type:       string(200)
      notnull:    true
    scope:
      type:       string(50)
      notnull:    false
  relations:
    Client:
      local:        client_identifier
      foreign:      client_identifier
      class:        OAuthClient
      foreignAlias: AuthorizationCodes
      onDelete:     CASCADE
      onUpdate:     CASCADE</p>

<p>OAuthRefreshToken:
  tableName:      oauth_refresh_token
  columns:
    refresh_token:
      type:       char(40)
      notnull:    true
      unique:     true
    client_identifier:
      type:       string(50)
      notnull:    true
    user_identifier:
      type:       string(100)
      notnull:    true
    expires:
      type:       timestamp
      notnull:    true
    scope:
      type:       string(50)
      notnull:    false
  relations:
    Client:
      local:        client_identifier
      foreign:      client_identifier
      class:        OAuthClient
      foreignAlias: RefreshTokens
      onDelete:     CASCADE
      onUpdate:     CASCADE
```</p>

<p>Now we can implement two more interfaces, <code>OAuth2\Storage\AuthorizationCodeInterface</code> and
<code>OAuth2\Storage\RefreshTokenInterface</code>.  This will allow us to use their correspoding grant
types as well.</p>

<p>Implement <code>OAuth2\Storage\AuthorizationCodeInterface</code> on the <code>OAuthAuthorizationCodeTable</code> class:</p>

<p>```php
class OAuthAuthorizationCodeTable extends PluginOAuthAuthorizationCodeTable implements OAuth2\Storage\AuthorizationCodeInterface
{
    public function getAuthorizationCode($code)
    {
        $auth_code = $this-&gt;createQuery()
            -&gt;where(‘code = ?’, $code)
            -&gt;fetchOne(array(), Doctrine_Core::HYDRATE_ARRAY);</p>

<pre><code>    if ($auth_code) {
        return array(
           'code'         =&gt; $auth_code['code'],
           'client_id'    =&gt; $auth_code['client_identifier'],
           'user_id'      =&gt; $auth_code['web_service_username'],
           'redirect_uri' =&gt; $auth_code['redirect_uri'],
           'expires'      =&gt; strtotime($auth_code['expires']),
           'scope'        =&gt; $auth_code['scope'],
        );
    }
    return null;
}

public function setAuthorizationCode($code, $client_id, $user_id, $redirect_uri, $expires, $scope = null)
{
    $auth_code = new OAuthAuthorizationCode();
    $auth_code-&gt;fromArray(array(
       'code'                 =&gt; $code,
       'client_identifier'    =&gt; $client_id,
       'web_service_username' =&gt; $user_id,
       'redirect_uri'         =&gt; $redirect_uri,
       'expires'              =&gt; date('Y-m-d H:i:s', $expires),
       'scope'                =&gt; $scope,
    ));

    $auth_code-&gt;save();
}

public function expireAuthorizationCode($code)
{
    return $this-&gt;createQuery()
        -&gt;delete()
        -&gt;where('code = ?', $code)
        -&gt;execute();
} } ```
</code></pre>

<p>Implement <code>OAuth2\Storage\RefreshTokenInterface</code> on the <code>OAuthRefreshTokenTable</code> class:</p>

<p>```php
class OAuthRefreshTokenTable extends PluginOAuthRefreshTokenTable implements OAuth2\Storage\RefreshTokenInterface
{
    public function getRefreshToken($refresh_token)
    {
        $refresh_token = $this-&gt;createQuery()
            -&gt;where(‘refresh_token = ?’, $refresh_token)
            -&gt;fetchOne(array(), Doctrine_Core::HYDRATE_ARRAY);</p>

<pre><code>    if ($auth_code) {
        return array(
           'refresh_token' =&gt; $refresh_token['refresh_token'],
           'client_id'     =&gt; $refresh_token['client_identifier'],
           'user_id'       =&gt; $refresh_token['user_identifier'],
           'expires'       =&gt; strtotime($refresh_token['expires']),
           'scope'         =&gt; $refresh_token['scope'],
        );
    }
}

public function setRefreshToken($refresh_token, $client_id, $user_id, $expires, $scope = null)
{
    $refresh_token = new OAuthRefreshToken();
    $refresh_token-&gt;fromArray(array(
       'code'              =&gt; $code,
       'client_identifier' =&gt; $client_id,
       'user_identifier'   =&gt; $user_id,
       'expires'           =&gt; date('Y-m-d H:i:s', $expires),
       'scope'             =&gt; $scope,
    ));

    $refresh_token-&gt;save();
}

public function unsetRefreshToken($refresh_token)
{
    return $this-&gt;createQuery()
        -&gt;delete()
        -&gt;where('refresh_token = ?', $refresh_token)
        -&gt;execute();
} } ```
</code></pre>

<p>Now we can add two more grant types onto our server:</p>

<p>```php
$clientStore  = Doctrine::getTable(‘OAuthClient’);
$tokenStore   = Doctrine::getTable(‘OAuthAccessToken’);
$codeStore    = Doctrine::getTable(‘OAuthAuthorizationCode’);
$refreshStore = Doctrine::getTable(‘OAuthRefreshToken’);</p>

<p>// Pass the doctrine storage objects to the OAuth2 server class
$server = new OAuth2\Server(array(
    ‘client_credentials’ =&gt; $clientStore,
    ‘access_token’       =&gt; $tokenStore,
    ‘authorization_code’ =&gt; $codeStore,
    ‘refresh_token’      =&gt; $refreshStore,
));</p>

<p>$server-&gt;addGrantType(new OAuth2\GrantType\ClientCredentials($clientStorage));
$server-&gt;addGrantType(new OAuth2\GrantType\AuthorizationCode($codeStorage));
$server-&gt;addGrantType(new OAuth2\GrantType\RefreshToken($refreshStorage));</p>

<p>// handle the request
$server-&gt;handleTokenRequest(OAuth2\Request::createFromGlobals())-&gt;send();
```</p>

<p>You’ve done it!!! Well, almost all of it.  The only thing left is to add your
user!  Well, see the symfony documentation for how to integrate with
<code>sfGuardUser</code>.</p>
      </div>

    <div id="js-sidebar" class="sidebar-shell">
      <div class="js-toggle-list sidebar-module expandable">
        <ul>
          <li class="js-topic">
            <h3><a href="#" class="js-expand-btn collapsed">&nbsp;</a><a href="/pages/oauth2-server-php-docs/cookbook/">Cookbook</a></h3>
            <ul class="js-guides">
              <li><a href="/oauth2-server-php-docs/cookbook/">Step-By-Step Walkthrough</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/silex/">Silex</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/doctrine/">Doctrine</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/drupal/">Drupal</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/google-playground/">Google Playground</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/symfony2/">Symfony2</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/doctrine2/">Doctrine2</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/symfony/">Symfony 1.4</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/laravel/">Laravel</a></li>
            </ul>
          </li>
          <li class="js-topic">
            <h3><a href="#" class="js-expand-btn collapsed">&nbsp;</a><a href="/pages/oauth2-server-php/methods/">Methods</a></h3>
          </li>
          <li class="js-topic">
            <h3><a href="#" class="js-expand-btn collapsed">&nbsp;</a><a href="/pages/oauth2-server-php/grant-types/">Grant Types</a></h3>
          </li>
          <li class="js-topic">
            <h3><a href="#" class="js-expand-btn collapsed">&nbsp;</a><a href="/pages/oauth2-server-php/response/">Response</a></h3>
          </li>
          <li class="js-topic">
            <h3><a href="#" class="js-expand-btn collapsed">&nbsp;</a><a href="/pages/oauth2-server-php/scope/">Scope</a></h3>
          </li>
          <li class="js-topic">
            <h3><a href="#" class="js-expand-btn collapsed">&nbsp;</a><a href="/pages/oauth2-server-php/userid/">User ID</a></h3>
          </li>
        </ul>
      </div> <!-- /sidebar-module -->
      <div class="sidebar-module">
        <p>This project is open source. Please help us by forking the project and adding to it.</p>
      </div>
    </div><!-- /sidebar-shell -->

    </div><!-- #wrapper -->

    <div id="footer" >
      <div class="upper_footer">
        <div class="footer_inner clearfix">

        </div><!-- /.site -->
      </div><!-- /.upper_footer -->

      <div class="lower_footer">
        <div class="footer_inner clearfix">
            <div id="legal">
              <p>&copy; <span id="year">year</span> Brent Shaffer. All rights reserved.</p>
            </div><!-- /#legal or /#legal_ie-->
        </div><!-- /.site -->
      </div><!-- /.lower_footer -->
    </div><!-- /#footer -->
</body>
</html>
